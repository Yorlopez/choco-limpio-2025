<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Chocó Limpio 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --verde-rio: #1a5f3d; --azul-pacifico: #0a3d62; --oro-choco: #d4a017; 
            --texto: #e0e0e0; --bg: #0f1a1e; --card-bg: rgba(255,255,255,0.08);
            --minutos-text: #a8e6cf; --arboles-text: #87ceeb;
        }
        * { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        body { background: linear-gradient(135deg, var(--bg) 0%, #1a2a2a 100%); color: var(--texto); min-height: 100vh; overflow-x: hidden; }
        
        .navbar-dashboard { 
            background: rgba(26,95,61,0.97); backdrop-filter: blur(15px); 
            border-bottom: 1px solid rgba(212,160,23,0.3); box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .stat-card { 
            background: var(--card-bg); border: 1px solid rgba(212,160,23,0.2); 
            border-radius: 24px; padding: 2rem; text-align: center; transition: all 0.4s ease; 
            backdrop-filter: blur(12px); position: relative; overflow: hidden;
        }
        .stat-card::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--verde-rio), var(--oro-choco));
        }
        .stat-card:hover { 
            transform: translateY(-12px) scale(1.03); 
            box-shadow: 0 25px 50px rgba(212,160,23,0.25); 
        }
        .stat-icon { 
            width: 85px; height: 85px; background: linear-gradient(135deg, var(--verde-rio), var(--azul-pacifico));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1rem; color: white; font-size: 2.2rem; box-shadow: 0 10px 25px rgba(26,95,61,0.5);
        }
        .progress-river { 
            height: 14px; border-radius: 50px; background: rgba(255,255,255,0.1); 
            overflow: hidden; position: relative; 
        }
        .progress-river::before { 
            content: ''; position: absolute; top: 0; left: 0; height: 100%;
            background: linear-gradient(90deg, #1a5f3d, #0a3d62); width: 75%; animation: flow 3.5s infinite;
        }
        @keyframes flow { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .ranking-badge { 
            width: 42px; height: 42px; background: var(--oro-choco); color: #000;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .impact-tree { 
            width: 65px; height: 65px; 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231a5f3d"><path d="M12 2L2 12h3v8h14v-8h3L12 2z"/></svg>') center/contain no-repeat;
        }
        .btn-premium { 
            background: linear-gradient(45deg, var(--oro-choco), #f1c40f); color: white; border: none; 
            padding: 14px 36px; border-radius: 50px; font-weight: 600; box-shadow: 0 10px 30px rgba(212,160,23,0.4); 
            transition: all 0.4s ease; font-size: 1.1rem;
        }
        .btn-premium:hover { 
            transform: translateY(-5px); box-shadow: 0 18px 40px rgba(212,160,23,0.5); 
        }
        canvas { border-radius: 18px; background: rgba(0,0,0,0.25); padding: 1.2rem; }
        .live-time { font-size: 1.1rem; font-weight: 500; color: var(--oro-choco); }
        .small-text { opacity: 0.9; font-weight: 500; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dashboard fixed-top">
        <div class="container">
            <a class="navbar-brand text-white d-flex align-items-center" href="/dashboard">
                <i class="bi bi-droplet-fill me-2"></i> Chocó Limpio 2025
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white me-2">¡Hola, <strong>{{ user.nombre.split(' ')[0] }}!</strong></span>
                <span class="live-time" id="liveTime"></span>
                <a href="/perfil" class="btn btn-outline-light btn-sm"><i class="bi bi-person"></i></a>
                <a href="/logout" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right"></i></a>
            </div>
        </div>
    </nav>

    <div class="container" style="padding-top: 110px;">

        <!-- HERO STATS -->
        <div class="row g-4 mb-5" data-aos="fade-up">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon"><i class="bi bi-recycle"></i></div>
                    <h3 class="display-4 fw-bold text-warning" id="kgTotal">{{ user.kg_reciclados|round(2) }} kg</h3>
                    <p class="lead mb-0">Reciclados</p>
                    <div class="progress-river mt-3"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon"><i class="bi bi-phone-vibrate"></i></div>
                    <h3 class="display-4 fw-bold text-success" id="minutosTotal">{{ user.minutos }}</h3>
                    <p class="lead mb-0">Minutos Ganados</p>
                    <small class="small-text" style="color: var(--minutos-text);">
                        1 kg = 15 min
                    </small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon impact-tree"></div>
                    <h3 class="display-4 fw-bold text-info" id="arbolesTotal">{{ user.kg_reciclados|int }}</h3>
                    <p class="lead mb-0">Árboles Plantados</p>
                    <small class="small-text" style="color: var(--arboles-text);">
                        1 kg = 1 árbol en el Atrato
                    </small>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-lg-8" data-aos="fade-up" data-aos-delay="100">
                <div class="card bg-dark text-white border-0 shadow-lg" style="border-radius: 20px;">
                    <div class="card-body p-4">
                        <h4 class="mb-4"><i class="bi bi-graph-up-arrow"></i> Progreso Semanal (Auto-update)</h4>
                        <canvas id="progressChart" height="130"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4" data-aos="fade-up" data-aos-delay="200">
                <div class="card bg-dark text-white border-0 shadow-lg h-100" style="border-radius: 20px;">
                    <div class="card-body p-4 d-flex flex-column">
                        <h4 class="mb-3"><i class="bi bi-trophy-fill text-warning"></i> Top 3</h4>
                        <div class="list-group list-group-flush flex-grow-1">
                            <div class="list-group-item bg-transparent text-white border-secondary d-flex align-items-center py-3">
                                <div class="ranking-badge me-3">1</div>
                                <div>Maria Quintero <small class="text-muted ms-auto">285 kg</small></div>
                            </div>
                            <div class="list-group-item bg-transparent text-white border-secondary d-flex align-items-center py-3">
                                <div class="ranking-badge me-3">2</div>
                                <div>Pedro Rivas <small class="text-muted ms-auto">240 kg</small></div>
                            </div>
                            <div class="list-group-item bg-transparent text-white border-secondary d-flex align-items-center py-3">
                                <div class="ranking-badge me-3">3</div>
                                <div>Lucía Mosquera <small class="text-muted ms-auto">195 kg</small></div>
                            </div>
                        </div>
                        <hr class="border-secondary">
                        <div class="text-center">
                            <div class="ranking-badge d-inline-flex mb-2" style="background: var(--oro-choco); width: 50px; height: 50px; font-size: 1.4rem;">
                                {{ (user.kg_reciclados * 10)|int }}
                            </div>
                            <p class="mb-0"><strong>TÚ:</strong> {{ user.kg_reciclados|round(1) }} kg</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-12 text-center" data-aos="zoom-in">
                <h3 class="mb-4">Acciones Rápidas</h3>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <a href="/reportar" class="btn btn-premium btn-lg">Reportar</a>
                    <a href="/mapa" class="btn btn-outline-light btn-lg">Mapa</a>
                    <a href="https://wa.me/573124567890" class="btn btn-success btn-lg">Llamar Lancha</a>
                </div>
            </div>
        </div>

        <div class="text-center py-5" data-aos="fade-up">
            <h2 class="display-5 mb-4">Tu impacto en el río Atrato</h2>
            <p class="lead fs-4">Has evitado que <strong class="text-warning">{{ (user.kg_reciclados * 2.5)|round(1) }} kg de CO₂</strong> lleguen al ambiente.</p>
            <div class="d-flex justify-content-center gap-4 flex-wrap mt-4">
                <div class="p-4 bg-success rounded-4 text-white shadow-sm" style="min-width: 140px;">
                    <strong>Río limpio</strong>
                </div>
                <div class="p-4 bg-info rounded-4 text-white shadow-sm" style="min-width: 140px;">
                    <strong>Fauna protegida</strong>
                </div>
                <div class="p-4 bg-warning rounded-4 text-dark shadow-sm" style="min-width: 140px;">
                    <strong>Comunidad unida</strong>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 1000, once: true });

        function updateTime() {
            const now = new Date();
            const options = { timeZone: 'America/Bogota', hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('liveTime').textContent = now.toLocaleTimeString('es-CO', options);
        }
        updateTime();
        setInterval(updateTime, 1000);

        let chart = null;
        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                    datasets: [{
                        label: 'Kg Reciclados',
                        data: [1.2, 2.1, 0.8, 3.5, 2.7, 4.1, {{ user.kg_reciclados }}],
                        borderColor: '#d4a017',
                        backgroundColor: 'rgba(212,160,23,0.2)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#d4a017',
                        pointRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } } }
                }
            });
        }

        async function updateStats() {
            const response = await fetch('/api/stats');
            const data = await response.json();
            if (data.success) {
                document.getElementById('kgTotal').textContent = data.kg_reciclados.toFixed(2) + ' kg';
                document.getElementById('minutosTotal').textContent = data.minutos;
                document.getElementById('arbolesTotal').textContent = Math.floor(data.kg_reciclados);

                chart.data.datasets[0].data[6] = data.kg_reciclados;
                chart.update('none');
            }
        }

        initChart();
        setInterval(updateStats, 30000);  
    </script>
</body>
</html>